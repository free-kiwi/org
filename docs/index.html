<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title id="pagetitle"></title>
<style>
body {
  font-size: 0.8em;
  margin: 0;
}

.header {
  font-size: 1.3em;
  margin: 10px 10px 0 5%;
}
.navbar {
  font-size: 1.3em;
  margin: 0 5% 0 5%;
  background-color: #333;
  overflow: hidden;
}
.navbar a {
  text-align: center;
  padding: 14px 16px;
  color: #f2f2f2;
  float: left;
}
.navbar a:hover {
  background-color: #ddd;
  color: black;
  text-decoration: none;
}
.navbar .search {
  padding: 9px 16px 9px 0;
  float: right;
  border: none;
  max-width: 90%;
}
.navbar .search button {
  background: #ddd;
  float: right;
  cursor: pointer;
  padding: 7px 6px 6px 6px;
  border: none;
}
.navbar .search input {
  padding: 7px 6px 6px 6px;
  border: none;
}
.page {
  margin: 10px auto 10px 5%;
}

a {
  color: #00B;
  text-decoration: none;
}
a:hover {
  text-decoration: underline;
  cursor: pointer;
}
#searchtable {
  max-width: 1000px;
  margin: 10px auto 10px 5%;
}
#searchresulttitle {
  font-size: 1.2em;
}
#moreresults {
  width: 100%;
  padding: 5px;
}
table {
  font-size: 0.9em;
  font-family: Verdana, Geneva, sans-serif;
  border-collapse: collapse;
  width: 100%;
  margin: 10px 0;
}
th {
  font-size: 1.1em;
}
td, th {
  border: 1px solid #e9e9e9;
  text-align: left;
  line-height: 1.3em;
  padding: 4px 0 4px 4px;
}
tr:nth-child(even) {
  background-color: #e9e9e9;
}
#hashresult {
  display: none;
  margin: 0 auto;
  width: 680px;
  background: #f5f7fa;
  padding: 10px;
}
#numberoffiles {
  cursor: pointer;
  border-bottom: 1px dotted;
}
#filelist {
  padding: 0;
  display: none;
  background: #fff;
  list-style-type: none;
}
pre {
  background: #fff;
  white-space: pre-wrap;
}
</style>
</head>

<body>
  <div class='header'>
	  <h1><a onclick='goto("Home")' style='color: #000;text-decoration: none;'>Title</a></h1>
  </div>
  <div class='navbar'>
    <a onclick='goto("Home")'>Home</a>
    <a onclick='goto("Forum")'>Forum</a>
    <a onclick='goto("About")'>About</a>
    <div class='search'>
      <input id="searchbox" onkeydown="submit(event)" type="text" placeholder="Torrent Search" autofocus>
      <button id="searchbutton" onclick="submit(event)" type="button">Search</button>
    </div>
  </div>
  <div id='Home' class='page'>
    <h3>Home</h3>
  </div>
  <div id='Forum' class='page'>
    <h3>Forum</h3>
  </div>
  <div id='About' class='page'>
    <h3>About</h3>
  </div>
  <div id='Search' class='page'>
    <p id="searchinfo">Search info</p>
    <table id='searchtable'>
      <thead>
        <tr>
          <th>Name (Sort by: <a onclick="sort(0)">Age</a>, <a onclick="sort(2)">Size</a>, <a onclick="sort(4)">Seeders</a>, <a onclick="sort(6)">Leechers</a>)</th>
          <th>Age</th>
          <th>Size</th>
          <th>Seeds</th>
          <th>Leeches</th>
        </tr>
      </thead>
      <tbody id="searchtablebody">
      </tbody>
    </table>
    <button id="moreresults" type="button"></button>
  </div>
  <div id='Hash' class='page'>
    <h4 id="torrenttitle"></h4>
    <p id="hash"></p>
    <p id="trackerinfo"></p>
    <p id="uploaded"></p>
    <p id="size"></p>
    <p><span id="numberoffiles""></span></p>
    <ol id="filelist"></ol>
    <pre id="description"></pre>
    <table>
      <thead>
        <tr>
          <th>Tracker</th>
          <th>Updated</th>
          <th>Seeders</th>
          <th>Leechers</th>
          <th>Downloads</th>
        </tr>
      </thead>
      <tbody id="trackertablebody">
      </tbody>
    </table>
  </div>

  <script type="text/javascript">
  function goto(location) { //navigation bar button
    history.pushState(location, null, '?'+location);
    navigate(location);
    }
  window.addEventListener('popstate', function() {  //forward or back button
    if (event.state==null) {
      navigate('Home');
    } else {
      navigate(event.state);
    }
  });
  function navigate(location) {
    console.log('navigating to',location);
    document.getElementById("pagetitle").innerHTML = location+' - Title';
    let pages = Array.from(document.getElementsByClassName('page'));
    pages.forEach(function(page){page.style.display = 'none';}); //hide all pages
    document.getElementById(location).style.display = 'block'; //unhide current page
    if (location == 'Search') {
      search();
    } else if (location == 'Hash') {
      hash();
    }
  }
  function submit(event) {
    if (event.key==='Enter' || event.buttons===0) {
      let query = decodeURIComponent(document.getElementById("searchbox").value);
      if (/^[A-F0-9]{40}$|^[a-f0-9]{40}$/.test(query)) {
	    history.pushState('Hash', null, '?Hash='+query);
        navigate('Hash');
      } else {
        history.pushState('Search', null, '?Search='+replace(query)+'&4');
        navigate('Search');
      }
    }
  }
  function search() {
    document.getElementById("searchtable").style.display = "none";
	document.getElementById("moreresults").style.display = "none";
    let searchparameter = location.search.substring(1).split("=")[1].split('&')[0]; //location.search = ?Search=title&4
    document.getElementById("searchbox").value = replace(decodeURIComponent(searchparameter));
	if (searchparameter == '') {
	  document.getElementById("searchinfo").innerHTML = "Nothing to search";
      return;
	} else {
      document.getElementById("searchinfo").innerHTML = "Searching...";
      document.getElementById("searchbutton").disabled = true; //search button not clickable
    }
	let sortoptions = ["u:desc,s", "u:asc,s", "b:desc,s", "b:asc,s", "s:desc,l", "s:asc,l", "l:desc,s", "l:asc,s"];
    let sort = sortoptions[location.search.split("&")[1]]
    document.getElementById("moreresults").setAttribute('onclick', "moreResults('25')"); //More Results button remembers next group
	let xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4) {
        document.getElementById("searchbutton").disabled = false; //search button clickable
        if (this.status == 0) {
          document.getElementById("searchinfo").innerHTML = "No response";
        } else if (this.status == 200) {
          let array = JSON.parse(this.responseText);
          if (array["hits"]["hits"].length == 26) {
            array["hits"]["hits"].pop(); //remove the 26th result
            document.getElementById("moreresults").innerHTML = "More Results";
            document.getElementById("moreresults").style.display = "block"; //unhide the More Results button
            document.getElementById("moreresults").disabled = false; //clickable
          }
          document.getElementById("searchtablebody").innerHTML = ""; //clear the table body
          array["hits"]["hits"].forEach(buildSearchTable); //add each result to the table individually
          if (array["hits"]["hits"] == "") {
            document.getElementById("searchinfo").innerHTML = "No results in "+array["took"]+"ms";
          } else {
            document.getElementById("searchinfo").innerHTML = "Search took "+array["took"]+"ms";
            document.getElementById("searchtable").style.display = "block"; //unhide the search table
          }
          if (array["timed_out"] == "true") {
            document.getElementById("searchinfo").innerHTML = "TIMED OUT in "+array["took"]+"ms (Showing partial results)";
          }
        } else { //if status not 200 - show status and message
          document.getElementById("searchinfo").innerHTML = this.status+" "+this.statusText;
        }
      }
    }
    xhttp.timeout=5000;
    xhttp.open("GET", 'https://api.freekiwi.org:9400/searchapi/'+searchparameter+'/'+sort+'/0', true);
    xhttp.send();
  }
  function buildSearchTable(data) { //put one search result into the table
    let tr = document.createElement("tr"), td = document.createElement("td"), a = document.createElement("a");
    a.setAttribute("onclick", "openHash('/hash/"+data["_id"]+"')");
    a.setAttribute("href", "/hash/"+data["_id"]);
    a.innerHTML = data["_source"]["title"];
    td.setAttribute("id", "searchresulttitle");
    td.appendChild(a);
    tr.appendChild(td);
    td = document.createElement("td");
    td.appendChild(document.createTextNode(getAge(data["_source"]["first_seen"])));
    tr.appendChild(td);
    td = document.createElement("td");
    td.appendChild(document.createTextNode(readableSize(data["_source"]["size"])));
    tr.appendChild(td);
    td = document.createElement("td");
    td.appendChild(document.createTextNode(data["_source"]["seeders"]));
    tr.appendChild(td);
    td = document.createElement("td");
    td.appendChild(document.createTextNode(data["_source"]["leechers"]));
    tr.appendChild(td);
    document.getElementById("searchtablebody").appendChild(tr);
  }

  function hash() {
    let infohash = location.search.substring(1).split("=")[1]; //location.search = ?Hash=INFOHASH
    console.log("loading hash:", infohash);
  }
  function replace(string) {
    string = string.replace(/[^ \-"0-9a-z]/gi,' ');
    return string;
  }
  function onLoad() {
    if (location.search=='') {
      navigate('Home');
    } else {
      navigate(decodeURIComponent(location.search.substring(1).split('=')[0]));
    }
  }
  onLoad(); //initial page load
  </script>
</body>
</html>
