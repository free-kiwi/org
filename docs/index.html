<!DOCTYPE html>
<html lang="en">
<head>
<link rel="preconnect" href="https://api.freekiwi.org:9400" crossorigin>
<meta charset="utf-8"/>
<title id="pagetitle"></title>
<style>
body {
  margin: 20px 20px 20px 5%;
  max-width: 1000px;
}
.header {
  font-size: 1em;
}
.navbar {
  font-size: 1em;
  background-color: #333;
  overflow: hidden;
}
.navbar a {
  text-align: center;
  padding: 14px 16px;
  color: #f2f2f2;
  float: left;
}
.navbar a:hover {
  background-color: #ddd;
  color: black;
  text-decoration: none;
}
.navbar .search {
  padding: 9px 16px 9px 0;
  float: right;
  border: none;
  max-width: 90%;
}
.navbar .search button {
  background: #ddd;
  float: right;
  cursor: pointer;
  padding: 7px 6px 6px 6px;
  border: none;
}
.navbar .search input {
  padding: 7px 6px 6px 6px;
  border: none;
}
.page {
  display: none;
}
a {
  color: #00B;
  text-decoration: none;
}
a:hover {
  text-decoration: underline;
  cursor: pointer;
}
table {
  font-size: 0.8em;
  font-family: Verdana, Geneva, sans-serif;
  border-collapse: collapse;
  width: 100%;
  white-space: nowrap;
}
th {
  font-size: 1.1em;
}
td, th {
  border: 1px solid #e9e9e9;
  text-align: left;
  line-height: 1.3em;
  padding: 4px;
}
tr:nth-child(even) {
  background-color: #e9e9e9;
}
#searchtable {
  max-width: 1000px;
}
#searchresulttitle {
  font-size: 1.1em;
  white-space: normal;
}
#moreresults {
  display: none;
  width: 100%;
  padding: 5px;
}
#hash {
  margin: 0 auto;
  max-width: 720px;
  background: #f5f7fa;
  padding: 10px;
}
#numberoffiles, #hashtabletitle {
  cursor: pointer;
  border-bottom: 1px dotted;
}
#filelist {
  padding: 0;
  display: none;
  background: #fff;
  list-style-type: none;
}
pre {
  background: #fff;
  white-space: pre-wrap;
}
</style>
</head>

<body>
  <div class='header'>
      <h1><a onclick='goto("Home")' style='color: #000;text-decoration: none;'>v0.0.1.50</a></h1>
  </div>
  <div class='navbar'>
    <a onclick='goto("Home")'>Home</a>
    <a onclick='goto("Search")'>Search</a>
    <a onclick='goto("About")'>About</a>
    <div class='search'>
      <input id="searchbox" onkeydown="submit(event)" type="text" placeholder="Search" autofocus>
      <button id="searchbutton" onclick="submit(event)" type="button">Search</button>
    </div>
  </div>
  <div id='Home' class='page'>
    <h3>Home</h3>
  </div>
  <div id='About' class='page'>
    <h3>About</h3>
  </div>
  <div id='Search' class='page'>
    <p id="globalsearchinfo"></p>
  </div>
  <div id='Hash' class='page'>
    <p id="globalhashinfo"></p>
  </div>

  <script type="text/javascript">
  function goto(location) { //navigation bar button
    history.pushState(location, null, '?'+location);
    navigate(location);
  }
  function submit(event) {
    if (event.key==='Enter' || event.buttons===0) {
      let query = decodeURIComponent(document.getElementById("searchbox").value);
      if (/^[A-F0-9]{40}$|^[a-f0-9]{40}$/.test(query)) {
        history.pushState('Hash', null, '?Hash='+query);
        navigate('Hash');
      } else {
        history.pushState('Search', null, '?Search='+replace(query)+'_4');
        navigate('Search');
      }
    }
  }
  window.addEventListener('popstate', function() {  //forward or back button
    if (event.state==null) {
      navigate('Home');
    } else {
      navigate(event.state);
    }
  });
  function navigate(location) {
    document.getElementById("pagetitle").innerHTML = location+' - Title';
    let pages = Array.from(document.getElementsByClassName('page'));
    pages.forEach(function(page){page.style.display = 'none';}); //hide all pages
    document.getElementById(location).style.display = 'block'; //unhide selected page
    if (location == 'Search') {
      search();
    } else if (location == 'Hash') {
      hash();
    }
  }
  function search() {
    let searchurl = decodeURIComponent(location.search.split("=")[1]); //location.search = ?Search=ex ample_4
    let query = searchurl.split('_')[0];
    searchurl = searchurl.replace(/[ ]/g,'_');
    document.getElementById("searchbox").value = query;
    if (query == '') {
      document.getElementById("globalsearchinfo").innerHTML = "Nothing to search";
      return;
    }
    document.getElementById("pagetitle").innerHTML = query+' - Title';
    if (document.body.getElementsByClassName('s'+searchurl)[0]) {
      document.getElementById('Search').style.display = 'none'; //hide Search page
      document.querySelector('.s'+searchurl).style.display = 'block'; //show the pre-loaded page
      return;
    }
    document.getElementById("searchbutton").disabled = true; //search button not clickable
    document.getElementById("searchbox").disabled = true; //search box not enterable
    document.getElementById("globalsearchinfo").innerHTML = "Searching...";
    let sort = ["udes", "uas", "bdes", "bas", "sdel", "sal", "ldes", "las"][location.search.split("_")[1]]; //sdel = Seeders:DEscending, then Leechers decending
    let xhttp = new XMLHttpRequest();
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4) {
        document.getElementById("searchbutton").disabled = false; //search button clickable
        document.getElementById("searchbox").disabled = false; //search box enterable
        if (this.status == 0) {
          document.getElementById("globalsearchinfo").innerHTML = "No response";
        } else if (this.status == 200) {
          document.getElementById('Search').style.display = 'none'; //hide Search page
          createSearchPage(searchurl);
          document.querySelector('.s'+searchurl+' #moreresults').setAttribute('onclick', "moreResults('"+searchurl+"', '25')"); //More Results button url and from
          let array = JSON.parse(this.responseText);
          if (array["hits"]["hits"] == "") {
            document.querySelector('.s'+searchurl+' #searchinfo').innerHTML = "No results in "+array["took"]+"ms";
          } else {
            if (array["hits"]["hits"].length == 26) {
              array["hits"]["hits"].pop(); //remove the 26th result
              document.querySelector('.s'+searchurl+' #moreresults').innerHTML = "More Results";
              document.querySelector('.s'+searchurl+' #moreresults').style.display = "block"; //show More Results button
              document.querySelector('.s'+searchurl+' #moreresults').disabled = false; //clickable
            }
            document.querySelector('.s'+searchurl+' #searchtablebody').innerHTML = ""; //clear the table body
            array["hits"]["hits"].forEach(buildSearchTable,searchurl); //add each result to the table individually
            if (array["timed_out"] == "true") {
              document.querySelector('.s'+searchurl+' #searchinfo').innerHTML = "TIMED OUT in "+array["took"]+"ms (Showing partial results)";
            } else {
              document.querySelector('.s'+searchurl+' #searchinfo').innerHTML = "Search took "+array["took"]+"ms";
            }
          }
          document.querySelector('.s'+searchurl).style.display = "block"; //show the page
        } else { //show status and message
          document.getElementById("globalsearchinfo").innerHTML = this.status+" "+this.statusText;
        }
      }
    }
    xhttp.timeout=9000;
    xhttp.open("GET", 'https://api.freekiwi.org:9400/searchapi/'+query+'/'+sort+'0', true);
    xhttp.send();
  }
  function createSearchPage(searchurl) {
    let div = document.createElement("div");
    div.setAttribute("class", "page s"+searchurl);
    div.innerHTML = `
    <p id="searchinfo"></p>
    <table id="searchtable">
      <thead>
        <tr>
          <th colspan="2"></th>
          <th>Name</th>
          <th><a onclick="sort(0)">Age</a></th>
          <th><a onclick="sort(2)">Size</a></th>
          <th><a onclick="sort(4)">Seeds</a></th>
          <th><a onclick="sort(6)">Leeches</a></th>
        </tr>
      </thead>
      <tbody id="searchtablebody">
      </tbody>
    </table>
    <button id="moreresults" type="button" style="display: none;"></button>`;
    document.body.appendChild(div);
  }
  function buildSearchTable(data) { //put one search result into the table
    let tr = document.createElement("tr"), td = document.createElement("td"), a = document.createElement("a"), span = document.createElement("span");
    tr.innerHTML = fileType(data['_source']['f']);
    //tr.appendChild(td);
    //td = document.createElement("td");
    a.setAttribute("onclick", "openHash('"+data["_id"]+"')");
    a.setAttribute("href", "?Hash="+data["_id"]);
    a.innerHTML = data["_source"]["t"];
    td.setAttribute("id", "searchresulttitle");
    td.appendChild(a);
    tr.appendChild(td);
    td = document.createElement("td");
    span.setAttribute("title", uploadedDate(data["_source"]["u"]));
    span.appendChild(document.createTextNode(getAge(data["_source"]["u"])))
    td.appendChild(span);
    tr.appendChild(td);
    td = document.createElement("td");
    span = document.createElement("span");
    span.setAttribute("title", data["_source"]["b"]+" bytes");
    span.appendChild(document.createTextNode(readableSize(data["_source"]["b"])));
    td.appendChild(span);
    tr.appendChild(td);
    td = document.createElement("td");
    td.setAttribute("style", "text-align: right;");
    td.appendChild(document.createTextNode(data["_source"]["s"]));
    tr.appendChild(td);
    td = document.createElement("td");
    td.setAttribute("style", "text-align: right;");
    td.appendChild(document.createTextNode(data["_source"]["l"]));
    tr.appendChild(td);
    document.querySelector('.s'+this+' #searchtablebody').appendChild(tr);
  }
  function sort(sortby) {
    if (Number(location.search.split("=")[1].split('_')[1]) == sortby) { //if already sorted, reverse
      var sort = sortby + 1;
    } else {
      var sort = sortby;
    }
    let query = decodeURIComponent(location.search.split("=")[1].split('_')[0]);
    history.pushState('Search', null, '?Search='+replace(query)+'_'+sort);
    navigate('Search');
  }
  function fileType(type) {
    if (typeof type == 'undefined') {return '';}
    type = type.toLowerCase();
    if (['mp4','mkv','avi','m4v'].includes(type)) {
      return '<td>\u{1F3A5}</td><td><span style="float: right;">'+type+'</span></td>';
    } else if (['mp3','m4b','flac'].includes(type)) {
      return '<td>\u{1F3B5}</td><td><span style="float: right;">'+type+'</span></td>';
    } else if (['epub','pdf','azw3','mobi'].includes(type)) {
      return '<td>\u{1F4DD}</td><td><span style="float: right;">'+type+'</span></td>';
    }
    return '<td></td><td>'+type+'</td>';
  }
  function moreResults(searchurl,from) {
    document.querySelector('.s'+searchurl+' #moreresults').disabled = true; //stop button being pressed again
    document.querySelector('.s'+searchurl+' #moreresults').innerHTML = "Loading...";
    let xhttp = new XMLHttpRequest(), query = searchurl.split('_').slice(0,-1).join(' '), sort = ["udes", "uas", "bdes", "bas", "sdel", "sal", "ldes", "las"][location.search.split("_").slice(-1)];
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4) {
        if (this.status == 200) {
          let array = JSON.parse(this.responseText);
          if (array["hits"]["hits"].length == 26) {
            array["hits"]["hits"].pop(); //remove the 26th result
            document.querySelector('.s'+searchurl+' #moreresults').innerHTML = "More Results"; //rename
            document.querySelector('.s'+searchurl+' #moreresults').setAttribute('onclick', "moreResults('"+searchurl+"', '"+(Number(from)+25).toString()+"')");
            document.querySelector('.s'+searchurl+' #moreresults').disabled = false; //button can be clicked again
          } else {
            document.querySelector('.s'+searchurl+' #moreresults').style.display = "none"; //hide Loading...
          }
          array["hits"]["hits"].forEach(buildSearchTable, searchurl);
        } else {
          document.querySelector('.s'+searchurl+' #moreresults').disabled = false;
          if (this.status == 0) {
            document.querySelector('.s'+searchurl+' #moreresults').innerHTML = "Try again (No response)";
          } else {
          document.querySelector('.s'+searchurl+' #moreresults').innerHTML = "Try again ("+this.status+" "+this.statusText+")";
          }
        }
      }
    }
    xhttp.timeout=9000;
    xhttp.open("GET", 'https://api.freekiwi.org:9400/searchapi/'+query+'/'+sort+from, true);
    xhttp.send();
  }
  function hash() {
    document.getElementById("globalhashinfo").innerHTML = "Loading...";
    let infohash = location.search.substring(1).split("=")[1].toUpperCase(), xhttp = new XMLHttpRequest();
    if (document.body.getElementsByClassName('h'+infohash)[0]) {
      document.getElementById("pagetitle").innerHTML = document.querySelector('.h'+infohash+' #hashtitle').innerHTML+' - Title';
      document.getElementById('Hash').style.display = 'none'; //hide Hash page
      document.querySelector('.h'+infohash).style.display = 'block'; //show the pre-loaded page
      return;
    }
    xhttp.onreadystatechange = function() {
      if (this.readyState == 4) {
        if (this.status == 0) {
          document.getElementById("globalhashinfo").innerHTML = "No response";
        } else if (this.status == 200) {
          document.getElementById('Hash').style.display = 'none'; //hide Hash page
          createHashPage(infohash)
          let sources = ["b", "t", "m", "p"], array = JSON.parse(this.responseText), seeders = 0, leechers = 0;
          let title = '', uploaded = 'unknown', size = 'unknown', files = '', description = '', numberoffiles = '';
          for (source of sources) {
            if (array[source]) {
              if (array[source]['b']) {size = array[source]['b'];}
              if (array[source]['t']) {title = array[source]['t'];}
              if (array[source]['f']) {files = array[source]['f'], numberoffiles = array[source]['f'].length;}
              if (array[source]['u']) {uploaded = array[source]['u'];}
              if (array[source]['d']) {description = array[source]['d'];}
              if (array[source]['n']) {numberoffiles = array[source]['n'];}
            }
          }
          document.getElementById("pagetitle").innerHTML = title+' - Title';
          document.querySelector('.h'+infohash+' #hashtitle').innerHTML = title;
          document.querySelector('.h'+infohash+' #infohash').innerHTML = infohash;
          document.querySelector('.h'+infohash+' #size').innerHTML = 'Size: '+readableSize(size);
          document.querySelector('.h'+infohash+' #size').setAttribute("title", size+" bytes");
          document.querySelector('.h'+infohash+' #description').innerHTML = description;
          document.querySelector('.h'+infohash+' #numberoffiles').innerHTML = "Files: "+numberoffiles;
          if (files == '') {
            document.querySelector('.h'+infohash+' #numberoffiles').innerHTML += " (Filelist not available)";
          } else {
            for (i in files) {
              let file = files[i].substring(0,files[i].lastIndexOf(':')), size = files[i].substring(files[i].lastIndexOf(':')+1);
              let li = document.createElement("li"), span = document.createElement("span");
              li.innerHTML = file;
              span.appendChild(document.createTextNode(readableSize(Number(size))));
              span.setAttribute("style", "float: right;");
              span.setAttribute("title", size+" bytes");
              li.appendChild(span);
              document.querySelector('.h'+infohash+' #filelist').appendChild(li);
            }
          }
          //let trackers = ["c", "l", "y", "u", "o"];
          for (tracker of ["c", "l", "y", "u", "o"]) {
            if (array[tracker]) {
              let earliest = Math.min(...Object.keys(array[tracker])), latest = Math.max(...Object.keys(array[tracker]));
              if (earliest < uploaded || uploaded == 'unknown') {uploaded = earliest;}
              if (latest > Date.now()/1000-999999) {
                if (array[tracker][latest]["s"] > seeders) {seeders = array[tracker][latest]["s"];}
                if (array[tracker][latest]["l"] > leechers) {leechers = array[tracker][latest]["l"];}
              }
              buildTrackerTable(tracker, array[tracker], infohash);
            }
          }
          document.querySelector('.h'+infohash+' #uploaded').innerHTML = "Uploaded: "+uploadedDate(uploaded);
          document.querySelector('.h'+infohash+' #trackerinfo').innerHTML = "Seeders: "+seeders+" Leechers: "+leechers;
          document.querySelector('.h'+infohash).style.display = "block"; //show hash page
        } else { //show status and associated text
          document.getElementById("globalhashinfo").innerHTML = this.status+" "+this.statusText;
        }
      }
    }
    xhttp.timeout=9000;
    xhttp.open("GET", 'https://api.freekiwi.org:9400/hashapi/'+infohash, true);
    xhttp.send();
  }
  function createHashPage(infohash) {
    let div = document.createElement("div");
    div.setAttribute("class", "page h"+infohash);
    div.innerHTML = `
    <div id="hash">
    <h4 id="hashtitle"></h4>
    <p id="infohash"></p>
    <p id="trackerinfo"></p>
    <p id="uploaded"></p>
    <p id="size"></p>
    <p><span id="numberoffiles"></span></p>
    <ol id="filelist" style="display: none;"></ol>
    <pre id="description"></pre>
    <p><span id='hashtabletitle'>Tracker Information</span></p>
    <table id="hashtable">
      <thead>
        <tr>
          <th>Tracker</th>
          <th>Scraped</th>
          <th>Seeders</th>
          <th>Leechers</th>
          <th>Downloads</th>
        </tr>
      </thead>
      <tbody id="tbody">
      </tbody>
    </table>
    <table id="detailedhashtable" style="display: none;">
      <thead>
        <tr>
          <th>Tracker</th>
          <th>Scraped</th>
          <th>Seeders</th>
          <th>Leechers</th>
          <th>Downloads</th>
        </tr>
      </thead>
      <tbody id="tbody">
      </tbody>
    </table>
    </div>`;
    document.body.appendChild(div);
    document.querySelector('.h'+infohash+' #numberoffiles').addEventListener("click", function() { //filelist collapse
      let content = document.querySelector('.h'+infohash+' #filelist');
      if (content.style.display == "block") {
        content.style.display = "none";
      } else {
        content.style.display = "block";
      }
    });
    document.querySelector('.h'+infohash+' #hashtabletitle').addEventListener("click", function() { //filelist collapse
      let detailed = document.querySelector('.h'+infohash+' #detailedhashtable'), normal = document.querySelector('.h'+infohash+' #hashtable');
      if (detailed.style.display == 'none') {
        normal.style.display = "none";
        detailed.style.display = "block";
      } else {
        detailed.style.display = "none";
        normal.style.display = "block";
      }
    });
  }
  function buildTrackerTable(tracker, data, infohash) { //build tracker table
    let sorted = [], trackers = {"c": '<a href="http://tracker.coppersurfer.tk/">Coppersurfer</a>', "l": '<a href="http://tracker.leechers-paradise.org/">Leechers Paradise</a>', "y": '<a href="http://tracker.cyberia.is/">Cyberia</a>', "u": "PublicBitTorrent", "o": "OpenBitTorrent"};
    for (let key in data) {
      sorted.push([key, data[key]]);
    }
    sorted.sort(function(a,b){return(b[0]-a[0]);});
    sorted.forEach(function(scrape) {
      if (typeof scrape[1]['d'] == 'undefined') {scrape[1]['d'] = '';}
      let inner1 = '<td id="hashresulttitle">'+trackers[tracker]+'</td><td>';
      let inner2 = '</td><td style="text-align: right;">'+scrape[1]['s']+'</td><td style="text-align: right;">'+scrape[1]['l']+'</td><td style="text-align: right;">'+scrape[1]['d']+'</td>';
      document.querySelector('.h'+infohash+' #detailedhashtable #tbody').innerHTML += inner1+new Date(scrape[0]*1000).toLocaleDateString()+inner2;
      if (scrape[0] == sorted[0][0]) {document.querySelector('.h'+infohash+' #hashtable #tbody').innerHTML += inner1+getAge(Number(scrape[0]))+' ago'+inner2;}
    });
  }
  function openHash(hash) {
    event.preventDefault();
    history.pushState('Hash', null, '?Hash='+hash);
    navigate('Hash');
  }
  function replace(string) {
    string = string.replace(/[^ \-"0-9a-z]/gi,' ');
    //replace "'" with ""
    return string;
  }
  function uploadedDate(unixtime) { //convert unix time to HH:mm dd MMM yyyy
    if (typeof unixtime != 'number') {return 'unknown';}
    let date = new Date(unixtime*1000), HH = date.getUTCHours(), mm = date.getUTCMinutes(), months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    if (HH < 10) {
      HH = '0'+HH;
    }
    if (mm < 10) {
      mm = '0'+mm;
    }
    return HH+':'+mm+' '+date.getUTCDate()+' '+months[date.getUTCMonth()]+' '+date.getUTCFullYear();
  }
  function getAge(unixtime) { //convert unixtime to age
    if (typeof unixtime != 'number') {return 'unknown';}
    let date = new Date(unixtime*1000), yyyy = new Date().getUTCFullYear() - date.getUTCFullYear(), MM = new Date().getUTCMonth() - date.getUTCMonth(), dd = new Date().getUTCDate() - date.getUTCDate(), HH = new Date().getUTCHours() - date.getUTCHours();
    if (HH < 0) {
      dd--;
      HH += 24;
    }
    if (dd < 0) {
      MM--;
      dd += new Date(date.getUTCFullYear(), date.getUTCMonth(), 0).getDate(); //gets number of days in the upload month
    }
    if (MM < 0) {
      yyyy--;
      MM += 12;
    }
    let ages = {0:[yyyy," year"], 1:[MM," month"], 2:[dd," day"], 3:[HH," hour"]};
    for (x in ages) {
      if (ages[x][0] != 0) {
        if (ages[x][0] == 1) {
          return ages[x][0]+ages[x][1];
        } else {
          return ages[x][0]+ages[x][1]+'s';
        }
      }
    }
    return '0 hours';
  }
  function readableSize(size) { //convert bits to human readable form
    if (typeof size != 'number') {return 'unknown';}
    let sizes = ["B", "KiB", "MiB", "GiB", "TiB", "PiB"];
    for (step = 0; step < 6; step++) {
      if (size < 1024**(step+1)) {
        return(Number((size/1024**step).toPrecision(4)).toString()+" "+sizes[step]);
      }
    }
  }
  if (location.search=='') {
    navigate('Home');
  } else {
    navigate(decodeURIComponent(location.search.substring(1).split('=')[0]));
  }
  </script>
</body>
</html>
